---
title: "R Markdownで日本語\\texttt{beamer}プレゼンテーション"
author: "ill-identified"
date: "`r Sys.Date()`"
output:
  rmdCJK::beamer_presentation_CJK:
    keep_md: false
    theme: metropolis
    highlight: tango
    citation_options: numbers
fontsize: 12pt
bibliography: examples.bib
biblio-style: jecon
mainfont: Roboto
sansfont: Noto Sans CJK JP
monofont: Ricty Diminished
CJKmainfont: Noto Sans CJK JP
---

```{r setup-document, include=F}
options(tinytex.latexmk.emulation = F)
file.copy(file.path(system.file("extdata", package = "rmdCJK"), "latexmk/.latexmkrc"), to = "./")
# 上記は日本語引用文献リストのために必要

# サンプル画像等を参照するパス
file_loc <- system.file("extdata", package = "rmdCJK")
# サンプル引用文献リストを取得する
file.copy(file.path(file_loc, "examples.bib"), to = "./")

knitr::opts_chunk$set(cache = T)
```

## 目次
\tableofcontents[hideallsubsections]

# イントロダクション

## このスライドは何?
* あまり情報が流れていない, rmarkdownとbeamerで日本語を含むスライドを作るためのテンプレート兼用例集
* `reveal.js`などhtml媒体は他の資料を参照
  + [ここ](https://kazutan.github.io/SappoRoR6/rmd_slide.html#/)や[ここ](https://kazutan.github.io/fukuokaR11/intro_rmarkdown_d.html)を見よ
* もともとは自分用に作ったテンプレだったものを万人向けに修正

## 想定される用途

* Tokyo.R などRを使った話を発表する際の資料作成
* 技術・アカデミック寄りの話題を想定
* 具体的に要求されるもの
  + **日本語表示**
  + ラスタまたはベクタ画像の挿入
  + 表の挿入
  + Rコードを見やすく表示
  + 参考文献の相互参照/リスト自動生成
  + **LyX やoverleafより簡単であること**
  + **なんかナウでオサレな感じは求めてない**
    + 自由すぎるデザインは不可

## 先行事例の紹介
* 伊東『[R MarkdownとBeamerでプレゼンテーション資料作成](https://www.slideshare.net/hirokito/r-markdownbeamer-88777082)』
  + \LuaLaTeX を使って日本語でBeamerスライド作成する方法
* Atusy 『[R Markdown + XeLaTeX で日本語含め好きなフォントを使って PDF を出力する](https://blog.atusy.net/2019/05/14/rmd2pdf-any-font/)』
* 先行事例との違い:
  + エンジンを\XeLaTeX に変更
  + 日本語文献bibファイル・bstファイルに対応
  +  スライド作例を多少充実させた
  + その他体裁にこだわりたい人向け
    - 「表X」「図X」といったキャプション

## `reveal.js` じゃダメなの?
* 個人的にデザインとかあまり好きじゃない
* 上下左右に動いて空間識失調になる
  + (個人の体験です)
  + 上下のみにもできる
* htmlよりも不変な媒体にしたい
  + pdfが明確に優れているかは怪しい
* ~~Q: お前が使いこなせてないだけじゃないの?~~
  + ~~A: うるさい~~


## パワーポイントじゃダメなの?
* 私は**持ってない**
* シンタックスハイライトが面倒
  + パワポの場合は[VSCode](https://notchained.hatenablog.com/entry/2017/02/20/221446)か[`reprex`](https://reprex.tidyverse.org/articles/articles/rtf.html)でコピペ
* ドラッグ&ドロップで位置調整は便利
* しかしポンチ絵芸術になりがち
* 極力シンプルにして視線誘導の負担をなくすべき
  + 徹底するかは**好みの問題**

## 技術的に厄介だったところ
* htmlとpdf(\LaTeX)とで微妙に違う挙動
  + ネット上の情報はhtml前提が多い
  + pandocチョットワカル必要
* 日本語を含む参考文献リスト
  + \upBibTeX の適用
  + 細かいオプション, 特に`metropolis`特有の仕様
* RStudio Cloud で動くかは未確認
  + 日本語表示がおかしい説あり
  
# 使い方

## セットアップ
1. パッケージのインストール

```{r install, eval=F, echo=T}
remotes::install_github(
  "Gedevan-Aleksizde/my_latex_templates",
  subdir = "rmdCJK")
```

2. TeXLive (>= 2018)のインストール
  + 分からなければ[TeX wiki のページ](https://texwiki.texjp.org/?TeX%20Live)を参考に
3. (オプション) [metropolisテーマ](https://github.com/matze/mtheme)のインストール

## 基本
1. yamlヘッダに以下を書く

```yaml
output:  rmdCKL::beamer_presentation_CJK
```

2. RStudioのツールバーの"Knit"を押す

```{r knit-image, out.width="80%"}
knitr::include_graphics(file.path(file_loc, "img/render.png"))
```

## フォント指定
* 使うマシンに応じて以下の箇所を適当に変える
* 初期設定はRictyを除き全て[Google Fonts](https://fonts.google.com/?category=Sans+Serif#standard-styles)で入手可
* インラインでのフォント変更は**想定してない**

```yaml
mainfont: Roboto
sansfont: Noto Sans CJK JP
monofont: Ricty Diminished
CJKmainfont: Noto Sans CJK JP
```

## 基本構文
- markdown的な書き方でできる
- "`## `タイトル" でスライドの開始
  + \LaTeX コマンドも挿入可能

```markdown
# 節見出し
## タイトル1
- **太字** **bold**
- _強調_ _emph_
- `タイプライタ体` `mono`
```

- **太字** **bold**
- _強調_ _emph_
- `タイプライタ体` `mono`

## BeamerやRMarkdown使用に役立つ資料

* 伊東『[R MarkdownとBeamerでプレゼンテーション資料作成](https://www.slideshare.net/hirokito/r-markdownbeamer-88777082)』(\LuaLaTeX 使用)
* 松田『[Beamer読本-講演用スライド作成のために-](http://ayapin-film.sakura.ne.jp/LaTeX/slides.html#beamer)』
* Kazutan『[R Markdownによるスライド生成](https://kazutan.github.io/SappoRoR6/rmd_slide.html#/)』『[R Markdown入門](https://kazutan.github.io/kazutanR/Rmd_intro.html)』
* Atusy『[R Markdown + XeLaTeX で日本語含め好きなフォントを使って PDF を出力する](https://blog.atusy.net/2019/05/14/rmd2pdf-any-font/)』
* R Markdown 2.0 チートシートの[日本語訳](https://rstudio.com/wp-content/uploads/2016/11/Rmarkdown-cheatsheet-2.0_ja.pdf), Takahashi, M.訳

## もう少しくわしいやつ

* Atusy 『[R MarkdownユーザーのためのPandoc’s Markdown](https://atusy.booth.pm/items/1453002)』
* 謝益輝 (yihui) "[knitr - Elegant, flexible, and fast dynamic report generation with R](https://yihui.org/knitr/)" (開発者本人)
* Xie, Yihui & C. Dervieux "[R Markdown Coobook](https://bookdown.org/yihui/rmarkdown-cookbook/)"

## 今回使うパッケージ

* このファイル作成には以下を使用している
  + 図表作成とか最低限必要なものだけ

```{r load-packages, echo=T, class.source = "numberLines LineAnchors"}
require(conflicted) # パッケージの競合防止用
require(tidyverse)  # 全般
require(ggthemes)   # ggplot2のデザイン変更
require(ggdag)      # ネットワーク図の用例に
```

* 以下はインストールのみ/読み込む必要なし
  - `citr`: 引用文献の挿入をGUIで
  - `bookdown`: 数式をGUIで

## ソースコードの表示: 基本事項
* `echo=T`でチャンク内コードを表示
  + デフォでは非表示
  + **自動でシンタックスハイライト**
* はみ出す場合は`tidy=F`して手動改行
  + 日本語等で折り返し地点がうまく行かない
* `class.source = "numberLines, LineAnchors"` で行番号表示([参考](https://blog.atusy.net/2019/04/18/rmd-line-num/))

## ソースコードの表示: 出力例

```{r display-chunk}
text <- '```{r, echo=T, class.source = "numberLines, LineAnchors"}
require(conflicted) 
require(tidyverse)
require(ggthemes)
require(ggdag)
```'
cat(text)
```

```{R load-packages2, echo=T, class.source = "numberLines LineAnchors", eval=F}
require(conflicted)
require(tidyverse)
require(ggthemes)
require(ggdag)
```


# 数式関係

## 数式の挿入: 行内(インライン)

* markdown風のLaTeXコード埋め込み
* \LaTeX の数式を`$`で挟む
* 例: `らんま$\frac{1}{2}$`
  + 出力: らんま$\frac{1}{2}$
  + 注: 行内で分数はスラッシュ使ったほうが見やすい
* 数式にはセリフフォント使用
  + スライドはサンセリフが良いとされる
  + しかし数式の統一感がない
  + (個人の好み?) 

## 数式の挿入: 独立行

* `$$`で挟んだ範囲に\LaTeX 構文

```latex
$$\begin{aligned}
& \sin^2(x) + \cos^2(x) = 1\\
& f(x) = \frac{1}{(2\pi)^2}\int_{\mathbb{R}^n}
\hat{f}(\omega)\exp(i\omega x)d\omega
\end{aligned}$$
```

$$\begin{aligned}
& \sin^2(x) + \cos^2(x) = 1\\
& f(x) = \frac{1}{(2\pi)^2}\int_{\mathbb{R}^n}\hat{f}(\omega)\exp(i\omega x)d\omega
\end{aligned}$$


## 数式の挿入: `bookdown` パッケージのアドインで補完

1. RStudioのツールバー "Addins"
2. "Input LaTeX Math"

```{r math-input, out.height="40%", fig.cap="bookdownの数式入力機能"}
knitr::include_graphics(file.path(file_loc, "img/math-input.png"))
```
* 一部対応してない記号もある?
  + `\mathbb{}`とか`\hat{}`とか
* 数式のみで`\aligned`等環境の入力は不可

# 図表の挿入

## 図の挿入: 画像ファイル貼り付け

* チャンクの`out.width=`/`out.height=`で調整
* htmlと違い**アスペクト比は固定**
* jpeg, png, eps, pdf に対応
  + gif, svg は上記いずれかに**手動で変換する**必要
  + \LaTeX (\XeLaTeX) の制約


```{r, echo=T, fig.cap="いつもの虎(TeXLiveより)", out.width="20%"}
knitr::include_graphics(file.path(file_loc, c("img/tiger.eps", "img/tiger.pdf", "img/tiger.png")))
```

## 図の挿入: markdown構文で貼り付け

* `out.width=`/`out.height=`が適用されない
* pandoc構文でサイズ指定

```markdown
![The Tiger](img/tiger.pdf){ height=30% }
```
![The Tiger](`r file.path(file_loc, "img/tiger.pdf")`){ height=30% }


## 図の挿入: `ggplot2`のグラフ

* `fig.cap=`でキャプションを設定可能. `labs(title = )`と違い自動相互参照あり
```{r ggplot2-theme}
theme_set(
  theme_classic(base_size = 11) +
  theme(legend.position = "top",
        axis.title.y = element_text(angle = 90, vjust = .5), legend.title = element_blank()))
```
```{r plot-example,  out.height="60%", fig.cap="ggplot2の出力例: irisデータ"}
data(iris)
g <- ggplot(iris, aes(x = Sepal.Length, y = Sepal.Width, color = Species)) +
  geom_point() + labs(x = "萼長", y = "萼幅")
g
```

## 図の挿入: 文字の大きさをそろえるには

* RStudioと出力された画像ファイルが違う!
* グラフの文字小さすぎ!!
* その原因は
1. **自動縮小される**ため
  + 込み入った話なので**次のスライドへ**
2. **単位が違う**ため
  + beamerは主に **pt**単位
  + `ggplot2` は `aanotate()`のみ**mm**単位
* 補足
  * `cairo_pdf()`の`pointsize`はビルトインデバイスにのみ影響
  * 『[ggplot2のsizeが意味するもの](https://uribo.hatenablog.com/entry/2018/06/11/232041)』

## 図の挿入: 画像サイズの基本ルール

* Rが作図したファイルを一旦保存し, 拡大縮小して貼り付けられる
  + `fig.width`/`fig.height` は**保存時**のサイズ
  + `out.width`/`out.height` は**表示する**サイズ
* Rの保存サイズとbeamerスライドのサイズのデフォルトは違う
  + スライドは**5.04 x 3.78 in (128 x 96 mm)**(4:3)
  + `ggsave()`は **9.11 x 5.77 in** で保存
* RStudioのビューアは文字の大きさ**固定**で**サイズを画面に合わせる**
  + **違和感の正体**(?)

## 図の挿入: 幅100%で出力

* 注: `out.width="100%"`はスライドサイズではなく**本文領域の相対サイズ**
````{r plot-size-test1, out.width="100%", fig.width=9.11, fig.height=5.77}
g + labs(title = "Iris") + theme_classic(base_size =11) + theme(axis.text = element_text(size = 11))
```

## 図の挿入: beamerサイズで保存, 幅100%で出力

* 相対的に文字が大きくなった
````{r plot-size-test2, out.width="100%"}
g + labs(title = "Iris") + theme_classic(base_size =11) + theme(axis.text = element_text(size = 11))
```


## 図の挿入: 字の大きさをなるべく揃える

* 基準をbeamerに合わせる方法
  1. 保存時サイズをbeamerの画面サイズと同じにする
  + このテンプレートのデフォルト設定
  2. `theme_*()`で`base_size`をbeamerの文字サイズと同じにする
* out.width="100%"のとき, グラフタイトルと本文のサイズが一致
* 拡大縮小に合わせて文字の大きさを調整する
* 横長のグラフなら`fig.width=` を調整する


## 図の挿入: 再現可能なポンチ絵

* 概念図とかの図示はどうするか
  + NOT データの視覚化(ビジュアライゼーション)
  + `ggplot2`の本来の使い方ではない
* `ggdag` はネットワーク図に使える
  + 因果ダイアグラム, 遷移図, グラフィカルモデル等
* `ggforce` は[ベン図の描画に応用可能](https://rpubs.com/sdutky/559050)
  + 世間的にはグラフの部分拡大用パッケージ?
* 詳しくは個別のマニュアル参照
* 霞が関流ポンチ絵は**専門外**

## 図の挿入: ポンチ絵の例1

* [以前作ったやつ](https://speakerdeck.com/ktgrstsh/r-and-epidemical-mathematical-models)の修正

```{r punch-chart-example, out.width="90%", out.height="70%", fig.cap="ggdagで作ったYJ-SEIRモデルの遷移図"}
diag_yjseir <- dagify(
  Y ~ E,
  J ~ E,
  S ~ Y,
  E ~ S,
  I ~ E + Y,
  R ~ J + I,
  labels = c("Y" = "懐疑", "J" = "間接接触", "S" = "感受性", "E" = "潜伏", "I" = "感染", "R" = "回復"),
  coords = list(x = c(Y = 1.5, J = 2, S = 0, E = 1, I = 2, R =3),
                y = c(Y = .5, J = -.5, S = 0, E = 0, I = 0, R = 0)
                )
  ) %>% tidy_dagitty() %>% mutate(label_edge = c("beta", NA, NA, "gamma", NA, "lambda",  NA, NA, NA))
diag_yjseir %>% ggplot(aes(x = x, y = y, xend = xend, yend = yend)) +
  geom_dag_node(size = 9 * .pt) +
  geom_dag_edges(edge_width = 2, arrow_directed = grid::arrow(length = grid::unit(.05, "npc"), type = "closed")) +
  geom_dag_text(aes(label = label)) +
  geom_label(aes(x = (x + xend)/2, y = (y + yend)/2, label = label_edge), parse = T, size = 10) +
  theme_dag_blank() + coord_cartesian(ylim=c(-1, 1))
```

## 図の挿入: ポンチ絵の例2

* `ggforce::geom_circle()` を利用
  + 参考: [How to Plot Venn Diagrams Using R, ggplot2 and ggforce](https://scriptsandstatistics.wordpress.com/2018/04/26/how-to-plot-venn-diagrams-using-r-ggplot2-and-ggforce/)

```{r venn, fig.cap="ベン図の例", out.height="60%"}
require(ggforce)
df.venn <- data.frame(
  x = c(-.5, 0, .5), y = c(0, .8, 0), r = c(1, 1, 1), labels = c('コーディング', 'デザイン', 'タイポグラフィ'))
ggplot(df.venn, aes(x0 = x, y0 = y, r = r, fill = labels)) +
  geom_circle(alpha = .3, size = 1, colour = 'grey') +
  geom_label(aes(x = x, y = y, label = labels)) +
  annotate("text", x = 0, y = .2, label = "LaTeX", size = 11 / .pt) +
  coord_fixed() + scale_fill_pander() +
  theme_void(base_size = 11) + theme(legend.position = "none")
```

## 図の挿入: R以外のデバイス

* \LaTeX の`tikz`を使用可能
  + `tikz`を知らない人は[ここ](https://www.opt.mist.i.u-tokyo.ac.jp/~tasuku/tikz.html)や[TeX Wiki](https://texwiki.texjp.org/?TikZ)を読む
  + 現時点では**日本語表示が面倒** ([参考](https://stackoverflow.com/questions/51689570/how-to-force-tikz-in-rmarkdown-document-to-show-cyrillic-text))
  + ~~そこまでやるなら全部\LaTeX で書いたほうがいいのではないか?~~
* dot言語単体で実行することも可能


## 表の挿入: データフレーム

- Rのデータフレームとして作成して出す
  + はみ出す場合は縮小
  + 最低限の情報だけ掲載するのは大前提
  + `df_print: kable` では`caption`指定が[ややこしい](https://stackoverflow.com/questions/48410861/how-to-add-table-caption-using-df-print)

```{r kable-iris, eval=F, echo=T}
data(iris)
knitr::kable(head(iris[, 1:3]),
             caption="kable()による表示")
```

## 表の挿入: データフレームを`kable()`で表示

```{r kable-iris-display, echo=T}
data(iris)
knitr::kable(head(iris[, 1:3]),
             caption="kable()による表示")
```

## 表の挿入: \LaTeX コード

* \LaTeX のコードを貼り付けて表を掲載
  + `\input{tab.tex}` でコピペなしで貼り付け可
  + `stargazer`との併用
  + **リサイズは手動で**
* 以下, 表を`.tex`で出力してから読み込む
  
```{r tex-tab, echo=T}
xtable::xtable(
  head(iris), caption = "xtableでexport") %>%
  print(file = "tab.tex")
```

\input{tab.tex}

## 表の挿入: markdown構文

\small
```
Table: 得点一覧

  クラス 科目   平均
  ------ ----- -----
  A      算数   $90$
  B      算数   $95$
  ------ ----- -----
```
\normalsize

Table: 得点一覧

  クラス 科目   平均
  ------ ----- -----
  A      算数   $90$
  B      算数   $95$
  ------ ----- -----

# 外部資料の引用方法

## ハイパーリンクの挿入

* urlは自動でリンク
  + https://rstudio.com/
* markdown方式のリンク
  + `[RStudio](https://rstudio.com/)`
  + [RStudio](https://rstudio.com/)
* 画像にハイパーリンク [![RStudio](`r file.path(file_loc, "img/RStudio-Logo-flat.pdf")`){ height=10% }](https://rstudio.com/) を貼ることも可

## 文献引用の方法

* `[@ref]` で番号引用: `\citep{ref}` に対応 (`[1]`)
* `@ref` で著者名引用: `\citet{ref}`に対応 (`hogehoge et al.`)
* `[@ref1; @ref1]` で連番引用 `[1, 2]`
* 以下引用テスト

```markdown
[@R-base; @R-bookdown; @R-citr; @wickham2016Data]
```

[@R-base; @R-bookdown; @R-citr; @wickham2016Data]

## 文献引用の補助: 引用子の補完

* 重複・書き間違えの防止
* `citr`パッケージを使うと楽
  + ツールバーの `Addins` から選択
  + zotero連携機能あり

```{r citr-image, fig.cap="citrパッケージのGUI", out.width="50%"}
knitr::include_graphics(file.path(file_loc, "img/citr.png"))
```

## 文献引用の補助: 文献管理

* Mendeley, Zotero, ReabCubeの3つが多い?
* 私はZoteroを使っている
  + 多言語対応, 連携機能の充実, 料金などの理由
  + 参考: 『[Mendeley Exodus Mendeley から Zotero への移行の手引き~](https://ill-identified.hatenablog.com/entry/2019/03/05/195257)』
* `RefManageR` パッケージ
  + Rでbibファイルをパースしたりする
  + 文献管理用には既存ソフトで十分?

# その他の機能

## 絵文字

* [`BXcoloremoji`](https://github.com/zr-tex8r/BXcoloremoji)をインストールすれば可能
  + `\coloremoji{}` で絵文字表示: \ifdefined\coloremoji \coloremoji{🍣} \else (ここに絵文字) \fi
* グラフ描画には特に設定必要なし
  + ソースコード上のものは文字化けする

```{r sushi-plot, echo=T, out.width="40%", align="center"}
plot(1:10, pch = "🍣")
```

# 基本的なカスタマイズ

## フォント変更

* `XeCJK` パッケージで制御している

```yaml
mainfont: Roboto
sansfont: Noto Sans CJK JP
monofont: Ricty Diminished
CJKmainfont: Noto Sans CJK JP
```

## スライドのテーマ変更

* 指定できる名前一覧は[ここ](https://deic-web.uab.cat/~iblanes/beamer_gallery/index.html)を参照
  + fonttheme のデフォルト値は `professionalfont`
  + metropolis はあまり変化がない

```yaml
output:
  rmdCJK::beamer_presentation_CJK:
    theme: metropolis
    colortheme: yellow
    outertheme: default
    innertheme: default
    fonttheme: default
```

## シンタックスハイライトのテーマ変更

* テーマは以下が用意されている
  + `default`, `tango`, `pygments`, `kate`, `monochrome`, `espresso`, `zenburn`, `haddock`, `breezedark`, `textmate`
    + 参考[Xie Yihui のドキュメント](https://bookdown.org/yihui/rmarkdown/html-document.html)

```yaml
output:
  rmdCJK::beamer_presentation_CJK:
  highlight: tango
```

## 色の変更

* ハイパーリンクの色を変えたい場合は以下をいじる
  + `linkcolor` スライド内リンク
  + `citecolor` 参考文献リストへのリンク
  + `urlcolor` urlリンク
* デフォルトで使用できる色名は[ここ](http://www.latex-cmd.com/style/color.html)を参照

```yaml
output:
  rmdCJK::beamer_presentation_CJK:
    linkcolor: blue
    citecolor: green
    urlcolor: red
```

## 引用形式の変更

* デフォルトでは `natbib` パッケージを使用
* デフォルトでは `[1]` のような番号形式
* 著者(年) 形式にしたい場合は `authoryear`
  + その他のオプションは[natnotes.pdf](http://texdoc.net/texmf-dist/doc/latex/natbib/natnotes.pdf)を参照
* `biblatex`/`biber` の使用は**想定していない**

```yaml
output:
  rmdCJK::beamer_presentation_CJK:
    citation-package: natbib
    citation-options: authoryear
```

## 参考文献リストの変更

* `.bib`, `.bst` は以下にファイルパスを指定する
* `.bst` は TeX側が認識していればフルパス・相対パスである必要なし

```yaml
bibliography: examples.bib
biblio-style: jecon
```

## 「図」「表」の表示

* 図や表を掲載すると自動で「図X」「表Y」などと表示される
  + "Fig.", "Tab." などと表示したい場合は以下のように変更

```yaml
output:
  rmdCJK::beamer_presentation_CJK:
    figurename: Fig.
    tablename: Tab.
```

# トラブルシューティング

## Q: エラーの原因がよくわからない
* A: **キャッシュ削除すると良くなることもある**
  + (**叩けば直る**レベルの雑アドバイス)
  + `{ファイル名}_cache`, `{ファイル名}_files` というディレクトリを消す
  + 前回失敗した際のキャッシュが悪さしてることは結構ある
  + または `cache = F`, `keep_tex: False`, `keep_md: False` でキャッシュを残さない
  + エラーメッセージが実態と矛盾してるときはまず試す
* A: `rmarkdown`/`knitr`と\LaTeX どちらのエラーか確認
  + `output file: {ファイル名}.md` と出ればpandocまでは機能している
  + pandocの変換が意図したものでない可能性はある

# まとめ

## 結果どうなったか
* **良く**なったこと
  + `lstlisting.sty`**より見やすい**シンタックスハイライト
  + Rの画像や数値出力を**コピペしなくて済む**
  + 一画面に収めるための構成だけ考えれば済むように
* **悪く**なったこと
  + (パワポユーザ的に)WYSIWYGでないので作りづらい?
  + 数式のリアルタイムレンダリング/補完はLyXが依然優秀
  + python作業中(jupyter notebookへの)**不満高まり**
  + ポンチ絵も`ggplot2`で作らねばという**強迫症状**

## 改良・機能追加したいところ

* 手動セットアップ作業の削減
  + TeXLive を入れなくても動かせるようにしたい
  + たぶん `tinytex` がネック 
* 細かいレイアウト修正
  + 例: キャプションが上か下かで統一されてない
* 他の言語のシンタックスハイライト
* `ggplot2` 以外で描かれたグラフの対応
  + 埋め込みはできるがフォントの調整が困難
  + `igraph` みたいなのとか...
* [issues](https://github.com/Gedevan-Aleksizde/my_latex_templates/labels/enhancement) に詳細

# 細かい技術的な話

## このセクションの想定読者

* 単に使いたいだけの人は見る必要なし
  + 内部処理知りたい人向け

## yamlヘッダ設定: 出力の設定

* \XeLaTeX 生成
  + \LuaLaTeX 使用者が多数派?
* "`keep_tex: true`" エラー発生時の原因特定に

```yaml
output:
  beamer_presentation:
    latex_engine: xelatex
    citation_package: natbib
    keep_tex: true
```

## \LaTeX プリアンブル: テーマ設定

* metropolisテーマを使用
  + https://github.com/matze/mtheme
  + 他のモダンなテーマは*日本語と相性悪い*
  + "`beamer_presentation:`" 内で指定すると**オプション指定できない**

```yaml
header-includes:
  - \usetheme[progressbar=frametitle,block=fill]{metropolis}
  - \makeatletter
  - \setlength{\metropolis@progressinheadfoot@linewidth}{2pt}
  - \usefonttheme{professionalfonts}
```

## \LaTeX プリアンブル: 日本語フォント設定

* `zxjatype` で日本語フォント読み込み**たかった**
  + 最新版で競合があるので `XeCJK` を使う

## \LaTeX プリアンブル: その他の設定

* ハイパーリンクの色を見やすく変更
* "Figure 1", "Table 1" を 「図1」「表1」に
* 参考文献リストのフォントサイズ縮小
* コードチャンクに行番号
  + 表示は選択式
* その他いろいろな微調整をtexのプリアンブルで設定

## 日本語文献にどう対応しているか

* [`jecon.bst`](https://github.com/ShiroTakeda/jecon-bst/blob/master/jecon.bst)を使いたい
  + マルチバイト文字未対応 の\BibTeX 
  + 日本語は \upBibTeX 必要
  + `biblatex` ではフォーマットに不満
* `knitr`は日本語書誌情報処理未対応
  + 内部では自前の設定で`latexmk`を呼び出し
  + 呼び出しているラッパにオプションなし
  + 積極的に改修の気配なし([参考](https://github.com/yihui/tinytex/issues/70))
* 自前の設定を使用する([参考](https://github.com/kenjimyzk/bookdown_ja_template))
  + `tinytex.latexmk.emulation = F`
  + [ここ](https://texwiki.texjp.org/?Latexmk)を参考に`.latexmkrc`設定
  + **Rmdと同じディレクトリに**上記を置く

## 謝辞

これを作るにあたって大いに参考になった資料

* kazutan: 『[R Markdownの内部とテンプレート開発](https://kazutan.github.io/HijiyamaR6/intoTheRmarkdown.html)』
* atusy:『[R Markdownのオリジナルフォーマットを作ろう](https://atusy.github.io/tokyor85-original-rmd-format/#/)』

----
`r if (knitr::is_latex_output()) '
\\section*{参考文献}
'`
